---
title: "eQTL PAN-CAN"
author: "Waldron Lab"
date: "March 6, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, warning = FALSE}
suppressPackageStartupMessages({
    library(MultiAssayExperiment)
    library(curatedTCGAData)
    library(TCGAutils)
    library(CNVRanger)
    library(BiocParallel)
})
```

Load packages:

```{r, eval = FALSE}
library(MultiAssayExperiment)
library(curatedTCGAData)
library(TCGAutils)
library(CNVRanger)
library(BiocParallel)
```

## Obtain ACC data from curatedTCGAData:
```{r}
data("diseaseCodes")
head(avail <- diseaseCodes[
    diseaseCodes[["Available"]] == "Yes", "Study.Abbreviation"])
```

```{r}
subChr <- function(obj, chrs) {
    seqlevelsStyle(obj) <- "UCSC"
    genome(rowRanges(obj)) <- "hg19"
    if (!missing(chrs))
        obj <- obj[seqnames(rowRanges(obj)) %in% chrs, ]
    obj
}

.addCallStates <-
    function(mae, calls_assay, sample = "01", col = "Segment_Mean") {
    calls_assay <- paste0(sample, "_", calls_assay)
    state <- round(mcols(mae[[calls_assay]])[[col]])
    state[state > 2] <- 2
    state[state < -2] <- -2
    mcols(mae[[calls_assay]])$State <- state + 2
    mcols(mae[[calls_assay]]) <-
        mcols(mae[[calls_assay]])[
            c("State", "Segment_Mean", "Num_Probes")]
}

```


```{r}
suppressMessages({
    pancan <- bplapply(avail, function(ccode, sample = "01") {
        mae <- curatedTCGAData::curatedTCGAData(ccode,
            assays = c("GISTIC_Peaks", "CNVSNP", "RNASeq2GeneNorm"),
            dry.run = FALSE)
        calls <- paste0(ccode, "_CNVSNP-20160128")
        rnas <- paste0(ccode, "_RNASeq2GeneNorm-20160128")
        cnvrs <- paste0(ccode, "_GISTIC_Peaks-20160128")
        scalls <- paste0(sample, "_", calls)
        srnas <- paste0(sample, "_", rnas)
        scnvrs <- paste0(sample, "_", cnvrs)
        
        mae[[calls]] <- subChr(mae[[calls]])
        mae <- symbolsToRanges(mae)
        mae <- mae[, , names(mae) != paste0(rnas, "_unranged")]
        mae[[rnas]] <- subChr(mae[[rnas]])
        mae <- intersectColumns(mae)
        mae <- splitAssays(mae, sampleCodes=sample)
        mae <- as(mae, "MatchedAssayExperiment")
        mae <- .addCallStates(mae, paste0(ccode, "_CNVSNP-20160128"))
        CNVRanger::cnvExprAssoc(
            cnvrs = scnvrs,
            calls = scalls,
            rcounts = paste0(srnas, "_ranged"),
            data = mae
        )
    })
})
```
