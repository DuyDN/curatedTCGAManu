---
title: "GSEA PanCan"
author: "Waldron Lab"
date: "May 10, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, warning = FALSE}
suppressPackageStartupMessages({
    library(MultiAssayExperiment)
    library(curatedTCGAData)
    library(TCGAutils)
    library(GSEABenchmarkeR)
    library(BiocParallel)
})
```

Load packages:

```{r, eval = FALSE}
library(MultiAssayExperiment)
library(curatedTCGAData)
library(TCGAutils)
library(GSEABenchmarkeR)
library(BiocParallel)
```

## Obtain ACC data from curatedTCGAData:

```{r}
data("diseaseCodes")
head(avail <- diseaseCodes[
    diseaseCodes[["Available"]] == "Yes", "Study.Abbreviation"])
```

## Download and reshape data

Some datasets were missing normals and we suspected that there were different
datasets being produced by RTCGAToolbox.
Upon further inspection, TCGA provides 'illuminaga' and 'illumina HiSeq'
datasets.

First, download the 'master' branch of RTCGAToolbox.

```{r}
## remotes::install_github("LiNk-NY/RTCGAToolbox")
library(RTCGAToolbox)
dl <- c("COAD", "READ", "UCEC")
redl <- lapply(setNames(dl, dl), function(x) {
    tx <- getFirehoseData(x, RNASeq2GeneNorm = TRUE, clinical = FALSE)
    txl <- biocExtract(tx, "RNASeq2GeneNorm")
    newassay <- cbind(assay(txl[[1]]), assay(txl[[2]]))
    newassay <- data.matrix(newassay[, !duplicated(colnames(newassay))])
    newmeta <- c(metadata(txl[[1]]), metadata(txl[[2]]))
    newColData <- DataFrame(row.names = colnames(newassay))
    SummarizedExperiment(assays = list(TPM = newassay),
        metadata = newmeta, colData = newColData)
    }
)
exper <- as(redl, "ExperimentList")
sampleTables(MultiAssayExperiment(exper))
```

```{r, eval = FALSE}
source("../data/ids.R")
ccids$sample %in% colnames(exper[[1]])
reids$sample %in% colnames(exper[[2]])
ceids$sample %in% colnames(exper[[3]])
```

Create a pseduo clinical DataFrame for new samples

```{r}
allSamps <- unlist(colnames(exper))
clinphone <- DataFrame(patientID = TCGAbarcode(allSamps))
rownames(clinphone) <- clinphone[["patientID"]]
clinphone <- clinphone[!duplicated(rownames(clinphone)), , drop = FALSE]
```

Check the correlation between platforms 'illuminaga' and 'illuminahiseq':

```{r}
lapply(1:3, function(i) {
    dfx <- data.frame(idx = seq(1, 6), place = rep(1:3, each= 2))
    ind <- dfx[dfx[["place"]] == i, "idx"]
    sameSamp <- Reduce(intersect, colnames(exper[ind]))

    cor(
        cbind.data.frame(
            assay(exper[[ind[1]]][, sameSamp]),
            assay(exper[[ind[2]]][, sameSamp])
        )
    )
})
## 0.8698399 for intersecting sample in UCEC
```

```{r}
outAssays <- c("COAD_RNASeq2GeneNorm-20160128",
    "READ_RNASeq2GeneNorm-20160128", "UCEC_RNASeq2GeneNorm-20160128")
core <- exper[ c("COAD", "READ", "UCEC") ]
names(core) <- outAssays
mapper <- generateMap(core, clinphone, idConverter = TCGAbarcode)
coremae <-
    MultiAssayExperiment(
        experiments = core, sampleMap = mapper, colData = clinphone
    )
```

Obtain the RNAseq data from `curatedTCGAData`:

```{r}
rnacomp <- curatedTCGAData("*", "RNASeq2*", FALSE)
```

```{r}
rnacopy <- rnacomp
rnacomp <- rnacomp[, , !names(rnacomp) %in% outAssays]
rnacomp <- c(rnacomp, coremae)
```

Here we check for the samples of interest using `sampleTables`:

```{r}
sampleTables(rnacomp)
```

Which cancer codes have both tumors and normal samples?

```{r}
okCA <- vapply(sampleTables(rnacomp),
    function(x) {
        all(c("01", "11") %in% names(x))
    },
    logical(1L)
)

(
okCodes <- vapply(
    strsplit(names(which(okCA)), "_"),
    `[`,
    character(1L),
    1L)
)
```

Assemble appropriate `MultiAssayExperiment` object with
cancer codes that have both tumors and normals.

```{r}
rnacomp2 <- rnacomp[ , , okCA]
```

Isolate tumor and normal samples for each cancer that have more than 10
samples of each:

```{r}
selects <- TCGAsampleSelect(colnames(rnacomp2), c("01", "11"))

rnacomp3 <- rnacomp2[, selects]
enoughNorm <- vapply(sampleTables(rnacomp3),
    function(samp) { samp["11"] >= 10L }, logical(1L))

rnacomp4 <- rnacomp3[, , enoughNorm]
sampleTables(rnacomp4)
```

Create an index to annotate each of the `SummarizedExperiment` objects
contained in the `ExperimentList`:

```{r}
tlogic <- TCGAsampleSelect(colnames(rnacomp4), "01")
sampIndx <- IntegerList(lapply(tlogic, ifelse, 1L, 0L))

naks <- mendoapply(function(x, y) {
    colData(x)[["GROUP"]] <- y
    colData(x)[["BLOCK"]] <- TCGAbarcode(rownames(colData(x)))
    x
}, x = experiments(rnacomp4), y = sampIndx)

rnacomp5 <- BiocGenerics:::replaceSlots(rnacomp4,
    ExperimentList = naks,
    check = FALSE)

table(rnacomp5[[1L]]$GROUP)
```

Split, create matched tumors and normals, and then recombine into a
single `MultiAssayExperiment`:

```{r}
matchlist <- lapply(setNames(seq_along(rnacomp5), names(rnacomp5)),
    function(idx) {
        as(splitAssays(rnacomp5[, , idx]), "MatchedAssayExperiment")
    }
)
newEXPS <- ExperimentList(
    lapply(matchlist, function(expr) {
        do.call(cbind, experiments(expr))
    })
)

rnacomp6 <- BiocGenerics:::replaceSlots(rnacomp5,
    ExperimentList = newEXPS,
    check = FALSE
)
```

Run Differential Expression analysis using `limma`

```{r}
res <- runDE(experiments(rnacomp6), padj.method="BH")
save(res, file = "~/data/pancan_DE_results.rda")
```

Run unmatched expresssion analysis using `limma`

```{r}
unmatch_rnacomp6 <- endoapply(experiments(rnacomp6), function(x) {
    colData(x) <- DataFrame(GROUP = colData(x)[, "GROUP"])
    x
})
res2 <- runDE(unmatch_rnacomp6, padj.method="BH")
save(res2, file = "~/data/pancan_DE_2.rda")
```

